<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout :: layout(~{::body})">
<body>
<section>
    <h1><i class="bi bi-question-circle me-1"></i>Ask a Question</h1>
    <p class="text-muted" th:text="'Logged in as ' + ${username}"></p>
    <div th:if="${status}" th:class="'alert alert-' + ${status}" th:text="${message}"></div>
    <form id="askForm" th:action="@{/ask}" method="post" th:object="${questionRequest}" class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Question:</label>
            <input type="text" th:field="*{text}" class="form-control" placeholder="Enter your question" data-bs-toggle="tooltip" title="Type your question" th:classappend="${#fields.hasErrors('text')}? ' is-invalid'" />
            <div class="invalid-feedback" th:if="${#fields.hasErrors('text')}" th:errors="*{text}"></div>
        </div>
        <div class="col-md-4">
            <label class="form-label">Document:</label>
            <select id="documentSelect" class="form-select" data-bs-toggle="tooltip" title="Select a document" th:classappend="${#fields.hasErrors('documentId')}? ' is-invalid'">
                <option value="" disabled>Select document</option>
                <option th:each="d : ${documents}" th:value="${d.id}" th:text="${d.name}"></option>
            </select>
            <input type="hidden" id="documentId" th:field="*{documentId}" />
            <div class="invalid-feedback" th:if="${#fields.hasErrors('documentId')}" th:errors="*{documentId}"></div>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" id="askBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Send question">
                <span id="askSpinner" class="spinner-border spinner-border-sm me-1 d-none" role="status" aria-hidden="true"></span>
                <i class="bi bi-send"></i> Ask
            </button>
        </div>
    </form>
    <div id="askLoading" class="text-info mt-2 d-none">Please wait...</div>
    <a class="btn btn-link mt-2" th:href="@{/history}"><i class="bi bi-clock-history"></i> View history</a>

    <div th:if="${answer}" th:replace="fragments/answer :: answerCard(${answer})"></div>
    <div th:if="${answer} == null" class="text-muted mt-3">No answer yet.</div>
</section>
<script>
    const form = document.getElementById('askForm');
    const btn = document.getElementById('askBtn');
    const spinner = document.getElementById('askSpinner');
    const loading = document.getElementById('askLoading');
    const docSelect = document.getElementById('documentSelect');
    const docId = document.getElementById('documentId');

    if(docSelect && docId){
        if(docId.value){
            docSelect.value = docId.value;
        }
        docSelect.addEventListener('change', ()=>{
            docId.value = docSelect.value;
        });
    }

    if(form){
        form.addEventListener('submit', function(){
            spinner.classList.remove('d-none');
            btn.disabled = true;
            if(loading){ loading.classList.remove('d-none'); }
        });
    }
</script>
</body>
</html>